<!DOCTYPE html>
html(lang="zh-Cn")
  head
    meta(charset="UTF-8")
    meta(name="keywords" content="Qymh个人json数据库")
    meta(name="description" content="Qymh个人json数据库")
    title Qymh
    link(rel="shortcut icon" href="http://nav.qymh.org.cn/static/images/q.ico" type="image/x-icon")
    link(rel="stylesheet", href="style/main.min.css")
  body(style="overflow-x:hidden;overflow-y:auto")
    .apiBox
      .font30.fb.mt30.h50.lh50.ml50= `${name}api管理`
      .form.mt10.ml50
        label.db.mt30 请输入要添加的属性
        input.input-center.mt15(
          placeholder="请输入要添加的属性..."
          v-model="property"
        )
        button.dib.h50.w50.ml15.lh50.tc.bkSky.colorWhite.br50.point.font12(
          @click="sendProperty"
        ) 添加
      p.ml50.mt15.h30.lh30 属性列表
      .form.ml50.col100.relative.propertiesBox
        p.dib.mt15.ml10.w380(v-for="one in properties")
          label.col20.dib.tc {{one.property}}:
          input.input-center.pl10(:placeholder="one.property")
          button.dib.h50.w50.ml25.lh50.tc.br50.btn-sky.point.font12(
            @click="deleteProperty($event)"
          ) 删除
        p.btn-small.tc.btn-sky.point.font12(
          style="position:absolute;bottom:-80px;right:18.5%;"
          @click="sendApi"
        ) 提交
      .limit.pl50.pr50
        table.col100.pl40(style="overflow:auto;margin-top:140px;")
          tr.col100
            th.col10.h35.lh35.tc.borderGrey(
              style="min-width:150px;"
              v-for="(value,key,index) in values[0]"
              contenteditable="true") {{key}}
          tr.col100(v-for="value in values")
            th.col10.h35.lh35.tc.borderGrey(
              :contenteditable="index==0||index==Object.keys(value).length-1?'false':'true'"
              v-for="(one,key,index) in value"
              @blur="putValue(key,$event)") {{one}}
            th.col10.h35.lh35.tc.colorPink.point.font12(
              @click="deleteValue($event)"
            ) 删除数据
      transition(
        name="alert"
        enter-active-class="animated fadeIn"
        leave-active-class="animated fadeOut"
      )
        component(:is="alert")  
  script(src="https://cdn.bootcss.com/vue/2.4.2/vue.js")
  script(src="https://cdn.bootcss.com/vue-resource/1.3.4/vue-resource.js")
  script.
    var api=new Vue({
      el:'.apiBox',
      data(){
        return{
          // 即将添加的属性
          property:'',
          // 属性数组
          properties:[],
          // 数据数组
          values:[],
          // 提示框状态
          alert:'normal',
          // 提示框显示时间
          basetime:400
        }
      },
      created(){
        // 判断登陆
        if(`#{res.locals.user}`){  
          let self=this

          // 获取属性值
          this.$http.get(`/api/#{name}/property`).then(res=>{
            self.properties=res.data
          })

          // 获取值
          this.$http.get(`/api/#{name}/value`).then(res=>{
            self.values=res.data
          })
        }else{
          window.location.href="/login"
        }


      },
      components:{
        success:{
          template:
          `
          <div class="alertBox">
            <div class="animated fadeIn alertSuccess font14 z999">操作成功</div>
          </div>
          `
        },
        error:{
          template:`
          <div class="alertBox">
            <div class="animated fadeIn alertSuccess font14 z999">请求失败
          </div>`
        },
        normal:{
          template:'<div></div>'
        }
      },
      methods:{
        // 发送property
        sendProperty(){

          let inner={
            property:this.property
          }

          // 清空属性输入框
          this.property=''
  
          let postResource=this.$resource(`/api/#{name}/property`)

          let self=this

          postResource.save(inner).then(res=>{
            self.alert="success"

            // 动态添加属性
            self.properties.push(inner)

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          },res=>{
            self.alert="error"

            var timer=setTimeout(()=>{
              self.alert="error"
            },self.basetime)
          })
        },
        // 删除property
        deleteProperty(e){
          let target=e.target
          let property=target.previousElementSibling.placeholder.trim()
          let inner={
            property:property
          }

          let deleteResource=this.$resource(`/api/#{name}/property`)

          let self=this

          deleteResource.delete(inner).then(res=>{
            self.alert="success"

            // 动态改变属性数组以更改显示 
            self.properties.find((item,index)=>{
              if(item.property==property){
                self.properties.splice(index,1)
              }
            })

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          },res=>{
            self.alert="error"

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          })
        },
        // post提交数据
        sendApi(e){
          let $input=document.querySelectorAll('.propertiesBox input')
          let len=$input.length
          let arr=[]

          for(let i=0;i<len;i++){
            let property=$input[i].placeholder
            let value=$input[i].value
            arr.push({
              property,
              value
            })
          }

          let postResource=this.$resource('/api/#{name}/value')

          let self=this

          postResource.save(arr).then(res=>{
            self.alert="success"

            // 动态改变数据数组
            self.values.push(res.data)

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          },res=>{
            self.alert="error"
            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          })
        },
        // put修改数据
        putValue(key,e){
          let target=e.target
          let id=target.parentNode.firstElementChild.innerHTML.trim()
          let value=target.innerHTML.trim()
          let putResource=this.$resource(`/api/#{name}/value`)
          let inner={
            id,
            key,
            value
          }
          let self=this

          putResource.update(inner).then(res=>{
            self.alert="success"

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          },res=>{
            self.alert="error"

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          })
        },
        // delete删除数据
        deleteValue(e){
          let target=e.target
          let id=target.parentNode.firstElementChild.innerHTML.trim()
          let deleteResource=this.$resource(`/api/#{name}/value`)
          let inner={
            id
          }
          let self=this

          deleteResource.delete(inner).then(res=>{
            self.alert="success"

            let inner=target.parentNode
            let outer=inner.parentNode
            outer.removeChild(inner)

            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          },res=>{
            self.alert="error"
            var timer=setTimeout(()=>{
              self.alert="normal"
            },self.basetime)
          })
        }
      }
    })
  