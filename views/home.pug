<!DOCTYPE html>
html(lang="zh-Cn")
  head
    meta(charset="UTF-8")
    meta(name="keywords" content="Qymh个人json数据库")
    meta(name="description" content="Qymh个人json数据库")
    title Qymh数据
    link(rel="shortcut icon" href="http://nav.qymh.org.cn/static/images/q.ico" type="image/x-icon")
    link(rel="stylesheet", href="style/main.min.css")
  body(style="overflow-x:hidden;overflow-y:auto")
    .home
      .font30.fb.mt30.h50.lh50.ml50= `api管理首页`
      .form.mt10.ml50
        p.dib
          label.db.mt30 请输入要添加的Api名称
          input.input-center.mt15(
            placeholder="请输入..."
            tabindex="1"
            v-model="api"
            @keydown.enter="sendBtnApi"
          )
        p.dib.ml30
          label.db.mt30 请输入对此Api的描述
          input.input-center.mt15(
            placeholder="请输入..."
            tabindex="2"
            v-model="apiDetails"
            @keydown.enter="sendBtnApi"
          )
        span.dib.ml30.btn-small.btn-sky.point.font12(
          @click="sendApi"
        ) 添加
      .apiBox.ml50.mt50.mr50
        table.col100
          tr.col100
            th.tc.borderGrey.h35.lh35(v-for="(value,key) in apis[0]") {{key}}
          tr.col100.point.hoverBkSky(
            v-for="(value,key) in apis")
            th.tc.borderGrey.h35.lh35(
              v-for="one in value"
              @click="toApi(value.api)") {{one}}
            td.tc.h35.lh35.tc.colorPink.point.font12.z999(
              @click="deleteApi($event).prevent.stop"
            ) 删除数据
      transition(
        name="alert"
        enter-active-class="animated fadeIn"
        leave-active-class="animated fadeOut"
      )
        component(:is="alert")(:target="target")
    script(src="https://cdn.bootcss.com/vue/2.4.2/vue.js")
    script(src="https://cdn.bootcss.com/vue-resource/1.3.4/vue-resource.js")
    script.
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?fa502c98dd7c3c357c291379ec7a5aa5";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    script.
      const api=new Vue({
        el:'.home',
        data(){
          return{
            // api名称
            api:'',
            // api描述
            apiDetails:'',
            // api数据
            apis:[],
            // 弹窗样式
            alert:'normal',
            // 弹窗提醒时间
            basetime:400,
            // 传入组件的target
            target:''
          }
        },
        created(){
          if(`#{res.locals.user}`){  
            let self=this
            this.$http.get('/api').then(res=>{
              self.apis=res.data
            })
          }else{
            window.location.href="/login"
          }
        },
        components:{
          success:{
            template:
            `
            <div class="alertBox">
              <div class="animated fadeIn alertSuccess font14 z999">
                操作成功
              </div>
            </div>
            `
          },
          error:{
            template:`
            <div class="alertBox">
              <div class="animated fadeIn alertError font14 z999">请求失败</div>
            </div>`
          },
          confirm:{
            template:`
            <div class="alertBox">
              <div class="animated fadeIn alertConfirm font14 z999 h50 lh50 w200">
                <div>删除数据后无法恢复,请再次点击确定后删除</div>
                <div>
                  <span @click="confirmBtn">确定</span>
                  <span @click="closeBtn">取消</span>
                </div>
              </div>
            </div>`,
            props:['target'],
            methods:{
              confirmBtn(){
                let target=this.target
                let id=target.parentNode.firstElementChild.innerHTML
                let now=target.parentNode
                let outer=now.parentNode
                let deleteResource=this.$resource('/api')
                let type=target.parentNode.firstElementChild.nextElementSibling.innerHTML.trim()

                let self=this.$parent

                deleteResource.delete({id:id,type:type}).then(res=>{
                  // 更改显示 
                  outer.removeChild(now)

                  self.alert="success"

                  var timer=setTimeout(()=>{
                    self.alert="normal"
                  },self.basetime)
                },res=>{
                  self.alert="error"

                  var timer=setTimeout(()=>{
                    self.alert="normal"
                  },self.basetime)
                })
                  },
                  closeBtn(){
                    this.$parent.alert='normal'
                  }
                }
          },
          normal:{
            template:'<div></div>'
          }
        },
        methods:{
          // 发送数据
          sendApi(){
            let postResource=this.$resource('/api')
            let now=new Date()
            let year=now.getFullYear() // 年
            let month=now.getMonth()+1 // 月
            let day=now.getDate() // 日
            let hour=now.getHours() // 时
            let minute=now.getMinutes() // 分
            let second=now.getSeconds() // 秒

            let time=year+'年'+month+'月'+day+'日'+hour+'时'+minute+'分'+second+'秒'

            let inner={
              api:this.api,
              apiDetails:this.apiDetails,
              time:time
            }

            let self=this

            postResource.save(inner).then(res=>{
              // 去除已写的值
              self.api=''
              self.apiDetails=''

              self.alert="success"

              var timer=setTimeout(()=>{
                self.alert="normal"
              },self.basetime)

              self.apis.push(res.data)
            },res=>{
              self.alert="error"

              var timer=setTimeout(()=>{
                self.alert="normal"
              },self.basetime)
            })
          },
          // 回车发送数据
          sendBtnApi(){
            this.sendApi()
          },
          // 删除数据
          deleteApi(e){
            let target=e.target

            this.target=target
            this.alert='confirm'
            /*
            let id=target.parentNode.firstElementChild.innerHTML
            let deleteResource=this.$resource('/api')
            let type=target.parentNode.firstElementChild.nextElementSibling.innerHTML.trim()

            let self=this

            // 动态改变api数组以更改显示 
            deleteResource.delete({id:id,type:type}).then(res=>{
              self.apis.find((item,index)=>{
                if(item._id==id){
                  self.apis.splice(index,1)
                }
              })

              self.alert="success"

              var timer=setTimeout(()=>{
                self.alert="normal"
              },self.basetime)
            },res=>{
              self.alert="error"

              var timer=setTimeout(()=>{
                self.alert="normal"
              },self.basetime)
            })
            */
          },
          // 跳转
          toApi(api){
            window.location.href=`/api/${api}`
          }
        }
      })
